name: Go CI

on:
  push:
    branches: [main]
    paths:
      - 'services/**'
      - 'pkg/**'
      - 'proto/**'
      - '.github/workflows/**'
      - '.golangci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'services/**'
      - 'pkg/**'
      - 'proto/**'
      - '.github/workflows/**'
      - '.golangci.yml'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module:
          - path: pkg
            name: pkg
          - path: services/product
            name: product
          - path: services/user
            name: user
          - path: services/inventory
            name: inventory
          - path: services/cart
            name: cart
          - path: services/order
            name: order
          - path: services/checkout
            name: checkout
          - path: services/payment
            name: payment
          - path: services/campaign
            name: campaign
          - path: services/notification
            name: notification
          - path: services/search
            name: search
          - path: services/media
            name: media
          - path: services/gateway
            name: gateway
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: golangci-lint (${{ matrix.module.name }})
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.1.6
          working-directory: ${{ matrix.module.path }}

  test-pkg:
    name: Test Shared Packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Test pkg
        working-directory: pkg
        run: go test ./... -v -count=1 -race -coverprofile=coverage.out

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: pkg-coverage
          path: pkg/coverage.out

  test-services:
    name: Test Services
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - product
          - user
          - inventory
          - cart
          - order
          - checkout
          - payment
          - campaign
          - notification
          - search
          - media
          - gateway
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Test ${{ matrix.service }}
        working-directory: services/${{ matrix.service }}
        run: go test ./... -v -count=1 -race -coverprofile=coverage.out

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-coverage
          path: services/${{ matrix.service }}/coverage.out

  security-scan:
    name: Security Scan (gosec)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module:
          - path: pkg
            name: pkg
          - path: services/product
            name: product
          - path: services/user
            name: user
          - path: services/inventory
            name: inventory
          - path: services/cart
            name: cart
          - path: services/order
            name: order
          - path: services/checkout
            name: checkout
          - path: services/payment
            name: payment
          - path: services/campaign
            name: campaign
          - path: services/notification
            name: notification
          - path: services/search
            name: search
          - path: services/media
            name: media
          - path: services/gateway
            name: gateway
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: gosec (${{ matrix.module.name }})
        working-directory: ${{ matrix.module.path }}
        run: gosec -quiet -exclude-dir=vendor -exclude-dir=testdata ./...

  vuln-check:
    name: Vulnerability Check (govulncheck)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module:
          - path: pkg
            name: pkg
          - path: services/product
            name: product
          - path: services/user
            name: user
          - path: services/inventory
            name: inventory
          - path: services/cart
            name: cart
          - path: services/order
            name: order
          - path: services/checkout
            name: checkout
          - path: services/payment
            name: payment
          - path: services/campaign
            name: campaign
          - path: services/notification
            name: notification
          - path: services/search
            name: search
          - path: services/media
            name: media
          - path: services/gateway
            name: gateway
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: govulncheck (${{ matrix.module.name }})
        working-directory: ${{ matrix.module.path }}
        run: govulncheck ./...

  build:
    name: Build Services
    runs-on: ubuntu-latest
    needs: [lint, test-pkg, test-services, security-scan, vuln-check]
    strategy:
      fail-fast: false
      matrix:
        service:
          - product
          - user
          - inventory
          - cart
          - order
          - checkout
          - payment
          - campaign
          - notification
          - search
          - media
          - gateway
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Build ${{ matrix.service }}
        working-directory: services/${{ matrix.service }}
        run: |
          CGO_ENABLED=0 GOOS=linux go build -o ../../bin/${{ matrix.service }} ./cmd/server

  build-all:
    name: Confirm All Services Compile
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Build all services
        run: |
          for svc in product user inventory cart order checkout payment campaign notification search media gateway; do
            echo "==> Building $svc..."
            (cd services/$svc && CGO_ENABLED=0 GOOS=linux go build -o /dev/null ./cmd/server) || exit 1
          done
          echo "ALL BUILDS OK"
