# =============================================================================
# docker-compose.yml
# Full stack -- all Go microservices, BFF, Next.js web frontend, plus the
# shared infrastructure defined in docker-compose.infra.yml.
#
# Usage:
#   docker compose up -d                                    # start everything
#   docker compose --profile infra up -d                    # infra only
#   docker compose --profile infra --profile backend up -d  # infra + backend
#   docker compose --profile infra --profile frontend up -d # infra + frontend
#   docker compose up -d product                            # one service + deps
#   docker compose logs -f product
# =============================================================================

include:
  - docker-compose.infra.yml

# ---------------------------------------------------------------------------
# Shared defaults for every Go microservice
# (Merge via YAML anchors to avoid repetition)
# ---------------------------------------------------------------------------
x-go-service-defaults: &go-service-defaults
  build:
    context: .
    dockerfile: docker/go-service.Dockerfile
    # SERVICE_NAME and SERVICE_PATH are overridden per-service below
    args:
      SERVICE_NAME: placeholder
      SERVICE_PATH: placeholder
  env_file:
    - .env
  restart: unless-stopped
  networks:
    - ecommerce-net
  depends_on:
    postgres:
      condition: service_healthy
    redis:
      condition: service_healthy
    kafka:
      condition: service_healthy

services:

  # ---------------------------------------------------------------------------
  # Product Service  -- HTTP :8001, gRPC :9001
  # ---------------------------------------------------------------------------
  product:
    <<: *go-service-defaults
    container_name: ecommerce-product
    profiles: ["backend"]
    build:
      context: .
      dockerfile: docker/go-service.Dockerfile
      args:
        SERVICE_NAME: product
        SERVICE_PATH: product
    environment:
      PRODUCT_HTTP_PORT: ${PRODUCT_HTTP_PORT:-8001}
      PRODUCT_GRPC_PORT: ${PRODUCT_GRPC_PORT:-9001}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-ecommerce}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ecommerce_secret}
      PRODUCT_DB_NAME: product_db
      REDIS_HOST: redis
      REDIS_PORT: 6379
      KAFKA_BROKERS: kafka:9092
    ports:
      - "${PRODUCT_HTTP_PORT:-8001}:${PRODUCT_HTTP_PORT:-8001}"
      - "${PRODUCT_GRPC_PORT:-9001}:${PRODUCT_GRPC_PORT:-9001}"

  # ---------------------------------------------------------------------------
  # Cart Service  -- HTTP :8002, gRPC :9002
  # ---------------------------------------------------------------------------
  cart:
    <<: *go-service-defaults
    container_name: ecommerce-cart
    profiles: ["backend"]
    build:
      context: .
      dockerfile: docker/go-service.Dockerfile
      args:
        SERVICE_NAME: cart
        SERVICE_PATH: cart
    environment:
      CART_HTTP_PORT: ${CART_HTTP_PORT:-8002}
      CART_GRPC_PORT: ${CART_GRPC_PORT:-9002}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-ecommerce}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ecommerce_secret}
      CART_DB_NAME: cart_db
      REDIS_HOST: redis
      REDIS_PORT: 6379
      KAFKA_BROKERS: kafka:9092
    ports:
      - "${CART_HTTP_PORT:-8002}:${CART_HTTP_PORT:-8002}"
      - "${CART_GRPC_PORT:-9002}:${CART_GRPC_PORT:-9002}"

  # ---------------------------------------------------------------------------
  # Order Service  -- HTTP :8003, gRPC :9003
  # ---------------------------------------------------------------------------
  order:
    <<: *go-service-defaults
    container_name: ecommerce-order
    profiles: ["backend"]
    build:
      context: .
      dockerfile: docker/go-service.Dockerfile
      args:
        SERVICE_NAME: order
        SERVICE_PATH: order
    environment:
      ORDER_HTTP_PORT: ${ORDER_HTTP_PORT:-8003}
      ORDER_GRPC_PORT: ${ORDER_GRPC_PORT:-9003}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-ecommerce}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ecommerce_secret}
      ORDER_DB_NAME: order_db
      REDIS_HOST: redis
      REDIS_PORT: 6379
      KAFKA_BROKERS: kafka:9092
    ports:
      - "${ORDER_HTTP_PORT:-8003}:${ORDER_HTTP_PORT:-8003}"
      - "${ORDER_GRPC_PORT:-9003}:${ORDER_GRPC_PORT:-9003}"

  # ---------------------------------------------------------------------------
  # Checkout Service  -- HTTP :8004
  # ---------------------------------------------------------------------------
  checkout:
    <<: *go-service-defaults
    container_name: ecommerce-checkout
    profiles: ["backend"]
    build:
      context: .
      dockerfile: docker/go-service.Dockerfile
      args:
        SERVICE_NAME: checkout
        SERVICE_PATH: checkout
    environment:
      CHECKOUT_HTTP_PORT: ${CHECKOUT_HTTP_PORT:-8004}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-ecommerce}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ecommerce_secret}
      CHECKOUT_DB_NAME: checkout_db
      REDIS_HOST: redis
      REDIS_PORT: 6379
      KAFKA_BROKERS: kafka:9092
    ports:
      - "${CHECKOUT_HTTP_PORT:-8004}:${CHECKOUT_HTTP_PORT:-8004}"

  # ---------------------------------------------------------------------------
  # Payment Service  -- HTTP :8005, gRPC :9005
  # ---------------------------------------------------------------------------
  payment:
    <<: *go-service-defaults
    container_name: ecommerce-payment
    profiles: ["backend"]
    build:
      context: .
      dockerfile: docker/go-service.Dockerfile
      args:
        SERVICE_NAME: payment
        SERVICE_PATH: payment
    environment:
      PAYMENT_HTTP_PORT: ${PAYMENT_HTTP_PORT:-8005}
      PAYMENT_GRPC_PORT: ${PAYMENT_GRPC_PORT:-9005}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-ecommerce}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ecommerce_secret}
      PAYMENT_DB_NAME: payment_db
      REDIS_HOST: redis
      REDIS_PORT: 6379
      KAFKA_BROKERS: kafka:9092
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-sk_test_xxx}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-whsec_xxx}
      PAYMENT_GATEWAY: ${PAYMENT_GATEWAY:-mock}
    ports:
      - "${PAYMENT_HTTP_PORT:-8005}:${PAYMENT_HTTP_PORT:-8005}"
      - "${PAYMENT_GRPC_PORT:-9005}:${PAYMENT_GRPC_PORT:-9005}"

  # ---------------------------------------------------------------------------
  # User Service  -- HTTP :8006, gRPC :9006
  # ---------------------------------------------------------------------------
  user:
    <<: *go-service-defaults
    container_name: ecommerce-user
    profiles: ["backend"]
    build:
      context: .
      dockerfile: docker/go-service.Dockerfile
      args:
        SERVICE_NAME: user
        SERVICE_PATH: user
    environment:
      USER_HTTP_PORT: ${USER_HTTP_PORT:-8006}
      USER_GRPC_PORT: ${USER_GRPC_PORT:-9006}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-ecommerce}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ecommerce_secret}
      USER_DB_NAME: user_db
      REDIS_HOST: redis
      REDIS_PORT: 6379
      KAFKA_BROKERS: kafka:9092
      JWT_SECRET: ${JWT_SECRET:-change-this-to-a-secure-secret-in-production}
      JWT_ACCESS_TOKEN_EXPIRY: ${JWT_ACCESS_TOKEN_EXPIRY:-15m}
      JWT_REFRESH_TOKEN_EXPIRY: ${JWT_REFRESH_TOKEN_EXPIRY:-168h}
    ports:
      - "${USER_HTTP_PORT:-8006}:${USER_HTTP_PORT:-8006}"
      - "${USER_GRPC_PORT:-9006}:${USER_GRPC_PORT:-9006}"

  # ---------------------------------------------------------------------------
  # Inventory Service  -- HTTP :8007, gRPC :9007
  # ---------------------------------------------------------------------------
  inventory:
    <<: *go-service-defaults
    container_name: ecommerce-inventory
    profiles: ["backend"]
    build:
      context: .
      dockerfile: docker/go-service.Dockerfile
      args:
        SERVICE_NAME: inventory
        SERVICE_PATH: inventory
    environment:
      INVENTORY_HTTP_PORT: ${INVENTORY_HTTP_PORT:-8007}
      INVENTORY_GRPC_PORT: ${INVENTORY_GRPC_PORT:-9007}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-ecommerce}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ecommerce_secret}
      INVENTORY_DB_NAME: inventory_db
      REDIS_HOST: redis
      REDIS_PORT: 6379
      KAFKA_BROKERS: kafka:9092
    ports:
      - "${INVENTORY_HTTP_PORT:-8007}:${INVENTORY_HTTP_PORT:-8007}"
      - "${INVENTORY_GRPC_PORT:-9007}:${INVENTORY_GRPC_PORT:-9007}"

  # ---------------------------------------------------------------------------
  # Campaign Service  -- HTTP :8008, gRPC :9008
  # ---------------------------------------------------------------------------
  campaign:
    <<: *go-service-defaults
    container_name: ecommerce-campaign
    profiles: ["backend"]
    build:
      context: .
      dockerfile: docker/go-service.Dockerfile
      args:
        SERVICE_NAME: campaign
        SERVICE_PATH: campaign
    environment:
      CAMPAIGN_HTTP_PORT: ${CAMPAIGN_HTTP_PORT:-8008}
      CAMPAIGN_GRPC_PORT: ${CAMPAIGN_GRPC_PORT:-9008}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-ecommerce}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ecommerce_secret}
      CAMPAIGN_DB_NAME: campaign_db
      REDIS_HOST: redis
      REDIS_PORT: 6379
      KAFKA_BROKERS: kafka:9092
    ports:
      - "${CAMPAIGN_HTTP_PORT:-8008}:${CAMPAIGN_HTTP_PORT:-8008}"
      - "${CAMPAIGN_GRPC_PORT:-9008}:${CAMPAIGN_GRPC_PORT:-9008}"

  # ---------------------------------------------------------------------------
  # Notification Service  -- HTTP :8009
  # ---------------------------------------------------------------------------
  notification:
    <<: *go-service-defaults
    container_name: ecommerce-notification
    profiles: ["backend"]
    build:
      context: .
      dockerfile: docker/go-service.Dockerfile
      args:
        SERVICE_NAME: notification
        SERVICE_PATH: notification
    environment:
      NOTIFICATION_HTTP_PORT: ${NOTIFICATION_HTTP_PORT:-8009}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-ecommerce}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ecommerce_secret}
      NOTIFICATION_DB_NAME: notification_db
      KAFKA_BROKERS: kafka:9092
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      SMTP_FROM: ${SMTP_FROM:-noreply@ecommercego.dev}
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      mailhog:
        condition: service_healthy
    ports:
      - "${NOTIFICATION_HTTP_PORT:-8009}:${NOTIFICATION_HTTP_PORT:-8009}"

  # ---------------------------------------------------------------------------
  # Search Service  -- HTTP :8010
  # ---------------------------------------------------------------------------
  search:
    <<: *go-service-defaults
    container_name: ecommerce-search
    profiles: ["backend"]
    build:
      context: .
      dockerfile: docker/go-service.Dockerfile
      args:
        SERVICE_NAME: search
        SERVICE_PATH: search
    environment:
      SEARCH_HTTP_PORT: ${SEARCH_HTTP_PORT:-8010}
      ELASTICSEARCH_URL: http://elasticsearch:9200
      KAFKA_BROKERS: kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    ports:
      - "${SEARCH_HTTP_PORT:-8010}:${SEARCH_HTTP_PORT:-8010}"

  # ---------------------------------------------------------------------------
  # Media Service  -- HTTP :8011
  # ---------------------------------------------------------------------------
  media:
    <<: *go-service-defaults
    container_name: ecommerce-media
    profiles: ["backend"]
    build:
      context: .
      dockerfile: docker/go-service.Dockerfile
      args:
        SERVICE_NAME: media
        SERVICE_PATH: media
    environment:
      MEDIA_HTTP_PORT: ${MEDIA_HTTP_PORT:-8011}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-ecommerce}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ecommerce_secret}
      MEDIA_DB_NAME: media_db
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET: ${MINIO_BUCKET:-ecommerce-media}
      MINIO_USE_SSL: ${MINIO_USE_SSL:-false}
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    ports:
      - "${MEDIA_HTTP_PORT:-8011}:${MEDIA_HTTP_PORT:-8011}"

  # ---------------------------------------------------------------------------
  # API Gateway  -- HTTP :8080
  # ---------------------------------------------------------------------------
  gateway:
    <<: *go-service-defaults
    container_name: ecommerce-gateway
    profiles: ["backend"]
    build:
      context: .
      dockerfile: docker/go-service.Dockerfile
      args:
        SERVICE_NAME: gateway
        SERVICE_PATH: gateway
    environment:
      GATEWAY_HTTP_PORT: ${GATEWAY_HTTP_PORT:-8080}
      JWT_SECRET: ${JWT_SECRET:-change-this-to-a-secure-secret-in-production}
      PRODUCT_GRPC_ADDR: product:${PRODUCT_GRPC_PORT:-9001}
      CART_GRPC_ADDR: cart:${CART_GRPC_PORT:-9002}
      ORDER_GRPC_ADDR: order:${ORDER_GRPC_PORT:-9003}
      USER_GRPC_ADDR: user:${USER_GRPC_PORT:-9006}
      INVENTORY_GRPC_ADDR: inventory:${INVENTORY_GRPC_PORT:-9007}
      PAYMENT_GRPC_ADDR: payment:${PAYMENT_GRPC_PORT:-9005}
    depends_on:
      - product
      - cart
      - order
      - user
      - payment
      - inventory
    ports:
      - "${GATEWAY_HTTP_PORT:-8080}:${GATEWAY_HTTP_PORT:-8080}"

  # ---------------------------------------------------------------------------
  # BFF (Backend For Frontend) -- Node/TypeScript  :3001
  # ---------------------------------------------------------------------------
  bff:
    build:
      context: .
      dockerfile: docker/bff.Dockerfile
    container_name: ecommerce-bff
    profiles: ["frontend"]
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      BFF_PORT: ${BFF_PORT:-3001}
      GATEWAY_URL: http://gateway:${GATEWAY_HTTP_PORT:-8080}
    depends_on:
      - gateway
    ports:
      - "${BFF_PORT:-3001}:${BFF_PORT:-3001}"
    networks:
      - ecommerce-net

  # ---------------------------------------------------------------------------
  # Web (Next.js storefront)  -- :3000
  # ---------------------------------------------------------------------------
  web:
    build:
      context: .
      dockerfile: docker/web.Dockerfile
    container_name: ecommerce-web
    profiles: ["frontend"]
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      PORT: ${WEB_PORT:-3000}
      # Next.js public env vars (available in browser bundles)
      NEXT_PUBLIC_API_URL: http://localhost:${GATEWAY_HTTP_PORT:-8080}
      NEXT_PUBLIC_BFF_URL: http://localhost:${BFF_PORT:-3001}
    depends_on:
      - bff
    ports:
      - "${WEB_PORT:-3000}:${WEB_PORT:-3000}"
    networks:
      - ecommerce-net
